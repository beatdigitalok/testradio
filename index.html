<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>beatdigital</title>
    <style>
        /* --- Estilos Generales --- */
        body { font-family: Arial, sans-serif; background:#121212; color:#fff; margin:0; }
        header { background:#1db954; padding:15px; text-align:center; font-size:22px; font-weight:bold; }
        section { padding:20px; margin-bottom:20px; }
        h2 { border-bottom:2px solid #1db954; padding-bottom:5px; }
        /* --- Estilos de Componentes --- */
        .card { 
            background:#1e1e1e; padding:10px; border-radius:8px; margin:10px 0; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            background: #282828;
        }
        iframe, audio, video { width:100%; border:none; border-radius:8px; }
        select { 
            width: 100%; 
            padding: 8px; 
            margin: 8px 0; 
            background: #1e1e1e; 
            color: #fff; 
            border: 1px solid #1db954; 
            border-radius: 5px; 
            box-sizing: border-box; 
        }
        a { color: #1db954; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>

<header>üéµ Mbogi Multimedia Hub - Radios ¬∑ TV ¬∑ Pelis ¬∑ M√∫sica Tendencia</header>

<section id="music-trends">
    <h2>üî• M√∫sica en Tendencia (Top 5 Global)</h2>
    <div id="trendMusicList">Cargando tendencias de Last.fm y buscando videos...</div>
</section>

---

<section id="radio">
    <h2>üìª Radios</h2>
    <select id="countrySelect"></select>
    <select id="radioSelect"></select>
    <audio id="radioPlayer" controls autoplay></audio>
</section>

<section id="tv">
    <h2>üì∫ TV en Vivo</h2>
    <select id="tvSelect"></select>
    <video id="tvPlayer" controls autoplay></video>
</section>

<section id="movies">
    <h2>üé¨ Pel√≠culas y Series</h2>
    <select id="movieSelect"></select>
    <video id="moviePlayer" controls autoplay></video>
</section>


<script>
// =====================================================================
// === Claves API: ¬°INSERTA TU CLAVE PERSONAL DE YOUTUBE AQU√ç! ===
// =====================================================================
const LASTFM_API_KEY = "1b44360cc775726f390e85afc14d8747"; 
const YOUTUBE_API_KEY = "AIzaSyBv8z1bP_rnp5XNTij2ugkDfKL0rHLLh00"; // ‚¨ÖÔ∏è ¬°IMPORTANTE! REEMPLAZAR ESTE TEXTO CON TU CLAVE REAL.

// =====================================================================
// === Funciones de M√∫sica (Last.fm + YouTube) ===
// =====================================================================

// Intenta buscar en YouTube con una consulta, con un mecanismo de reintento.
async function searchYoutube(query) {
    const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=1&q=${encodeURIComponent(query)}&key=${YOUTUBE_API_KEY}`;
    const res = await fetch(url);
    const data = await res.json();
    
    // Si hay error en la API, lo reporta
    if (data.error) {
        console.error("Error de la API de YouTube:", data.error.message);
        return null;
    }
    
    // Devuelve el video si lo encuentra, o null si la lista est√° vac√≠a.
    return (data.items && data.items.length > 0) ? data.items[0] : null;
}

// Busca el video de YouTube para una canci√≥n espec√≠fica con l√≥gica de reintento
async function findAndEmbedVideo(trackName, artistName, containerElement) {
    let video = null;
    let title = `${trackName} - ${artistName}`;

    // 1. Intento principal: B√∫squeda exacta (como lo har√≠a Bruga Music)
    const query1 = `${trackName} ${artistName} official video`;
    video = await searchYoutube(query1);

    // 2. Fallback: B√∫squeda menos espec√≠fica (a veces mejor para videos no oficiales)
    if (!video) {
        const query2 = `${trackName} ${artistName} lyric`;
        video = await searchYoutube(query2);
    }
    
    // 3. Renderizar el resultado
    if (video) {
        const videoId = video.id.videoId;
        
        containerElement.innerHTML += `
            <div class="card">
                <p style="font-weight: bold; margin-bottom: 5px;">${title} (Buscado por Last.fm)</p>
                <iframe width="100%" height="200"
                    src="http://googleusercontent.com/youtube.com/embed/${videoId}"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen></iframe>
            </div>`;
    } else {
        containerElement.innerHTML += `<div class="card"><p>No se encontr√≥ video en YouTube para: <strong>${title}</strong>.</p></div>`;
    }
}

// Carga Top Tracks de Last.fm y luego los busca en YouTube
async function loadMusicTrends() {
    const listElement = document.getElementById("trendMusicList");
    listElement.innerHTML = "Obteniendo Top Tracks de Last.fm...";
    
    const method = "chart.gettoptracks";
    const limit = 5; 
    const url = `https://ws.audioscrobbler.com/2.0/?method=${method}&api_key=${LASTFM_API_KEY}&format=json&limit=${limit}`;

    try {
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.tracks && data.tracks.track) {
            listElement.innerHTML = "";
            const tracks = data.tracks.track;
            
            // Llama a la b√∫squeda de YouTube por cada track de Last.fm
            for (const t of tracks) {
                // Usamos await para que los videos se carguen en orden y se muestren correctamente
                await findAndEmbedVideo(t.name, t.artist.name, listElement);
            }
            
        } else {
            listElement.innerHTML = "<p>‚ö†Ô∏è No se pudieron cargar las tendencias de Last.fm. Revisa tu clave.</p>";
        }
        
    } catch (err) {
        listElement.innerHTML = "<p>‚ùå Error de conexi√≥n al cargar tendencias de Last.fm.</p>";
        console.error("Error Last.fm:", err);
    }
}


// =====================================================================
// === Funciones de Radio (Radio Browser) ===
// =====================================================================
async function loadCountries() {
    const res = await fetch("https://de1.api.radio-browser.info/json/countries");
    const countries = await res.json();
    const countrySelect = document.getElementById("countrySelect");
    countries.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.name;
        opt.textContent = c.name;
        countrySelect.appendChild(opt);
    });
    countrySelect.value = "Argentina";
    loadRadios(countrySelect.value);
    countrySelect.addEventListener("change", () => {
        loadRadios(countrySelect.value);
    });
}

async function loadRadios(country) {
    const res = await fetch(`https://de1.api.radio-browser.info/json/stations/bycountry/${encodeURIComponent(country)}`);
    const radios = await res.json();
    const radioSelect = document.getElementById("radioSelect");
    radioSelect.innerHTML = "";
    
    radios.slice(0, 20).forEach(r => { 
        const opt = document.createElement("option");
        opt.value = r.url_resolved;
        opt.textContent = r.name;
        radioSelect.appendChild(opt);
    });
    const player = document.getElementById("radioPlayer");
    
    radioSelect.addEventListener("change", () => {
        player.src = radioSelect.value;
        player.play();
    });
    
    if (radioSelect.value) {
        player.src = radioSelect.value;
        player.play();
    }
}

// =====================================================================
// === Funciones de TV / Pelis (Demos IPTV) ===
// =====================================================================
function playHLS(videoElement, url) {
    if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(videoElement);
        videoElement.play();
    } else if (videoElement.canPlayType("application/vnd.apple.mpegurl")) {
        videoElement.src = url;
        videoElement.play();
    } else {
        console.error("Tu navegador no soporta la reproducci√≥n de este stream.");
    }
}

/* --- IPTV: canales demo --- */
function loadIPTV() {
    const channels = [
        {name: "Canal Demo 1 (Mux)", url: "https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8"},
        {name: "Canal Demo 2 (Test)", url: "https://test-streams.mux.dev/test_001/stream.m3u8"}
    ];
    const select = document.getElementById("tvSelect");
    channels.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.url;
        opt.textContent = c.name;
        select.appendChild(opt);
    });
    const video = document.getElementById("tvPlayer");
    
    playHLS(video, select.value);
    select.addEventListener("change", () => {
        playHLS(video, select.value);
    });
}

/* --- Pelis / Series: demos --- */
function loadMovies() {
    const movies = [
        {name: "Big Buck Bunny (Demo)", url: "https://test-streams.mux.dev/bigbuckbunny/master.m3u8"},
        {name: "Serie Demo Cap√≠tulo 1", url: "https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8"}
    ];
    const select = document.getElementById("movieSelect");
    movies.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m.url;
        opt.textContent = m.name;
        select.appendChild(opt);
    });
    const player = document.getElementById("moviePlayer");
    
    playHLS(player, select.value);
    select.addEventListener("change", () => {
        playHLS(player, select.value);
    });
}

// =====================================================================
// === Inicializaci√≥n y Eventos ===
// =====================================================================
document.addEventListener("DOMContentLoaded", () => {
    // Carga la nueva secci√≥n de m√∫sica combinada
    loadMusicTrends(); 
    
    // Carga las otras secciones
    loadCountries();
    loadIPTV();
    loadMovies();
});
</script>

</body>
</html>